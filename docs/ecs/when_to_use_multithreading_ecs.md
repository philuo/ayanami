# 多线程 ECS 适用场景分析

╔═══════════════════════════════════════════════════════════════╗
║  ⚖️ 多线程 ECS 的成本与收益                                   ║
╚═══════════════════════════════════════════════════════════════╝

## 成本（Costs）

1. 复杂度开销
   - 内存布局设计
   - 同步机制
   - 数据竞争调试
   - 代码维护难度 ↑

2. 性能开销
   - 线程创建/销毁
   - Atomic 操作（~10-100 cycles）
   - 缓存一致性协议
   - 内存带宽竞争

3. 开发成本
   - 开发时间 2-3 倍
   - 调试难度 5-10 倍
   - 需要更高技能水平

## 收益（Benefits）

1. 性能提升
   - 理论最大：N 核 → N 倍速度
   - 实际：2-3 倍（4核情况）
   - 前提：任务可并行化

2. 支持更多内容
   - 更多 entities
   - 更复杂系统
   - 更大世界


╔═══════════════════════════════════════════════════════════════╗
║  📊 实际性能分析                                               ║
╚═══════════════════════════════════════════════════════════════╝

## Entity 数量临界点

┌────────────────────────────────────────────────────────────┐
│ Entity数量    单线程性能    多线程性能    收益    值得吗？   │
├────────────────────────────────────────────────────────────┤
│ 100          0.5ms        1ms          -0.5ms   ❌         │
│ 500          2ms          2.5ms        -0.5ms   ❌         │
│ 1,000        4ms          3ms          +1ms     ⚠️         │
│ 2,000        8ms          4ms          +4ms     ✅         │
│ 5,000        20ms         7ms          +13ms    ✅         │
│ 10,000       40ms         12ms         +28ms    ✅✅       │
│ 50,000       200ms        50ms         +150ms   ✅✅✅     │
└────────────────────────────────────────────────────────────┘

💡 经验法则：
  > 2000 entities + 复杂系统 → 考虑多线程
  < 1000 entities           → 单线程足够


## 系统复杂度临界点

┌────────────────────────────────────────────────────────────┐
│ 系统类型              单线程    多线程    适合多线程？      │
├────────────────────────────────────────────────────────────┤
│ 简单移动              0.1ms    0.3ms     ❌ 开销>收益      │
│ 碰撞检测(广相位)       2ms      1ms      ⚠️ 看entity数    │
│ 碰撞检测(细相位)       10ms     3ms      ✅ 值得          │
│ 物理模拟              15ms     5ms      ✅ 值得          │
│ AI决策(简单)          1ms      1.5ms    ❌ 开销>收益      │
│ AI决策(复杂行为树)     8ms      3ms      ✅ 值得          │
│ 路径规划              20ms     6ms      ✅ 值得          │
│ 视野计算              5ms      2ms      ✅ 值得          │
└────────────────────────────────────────────────────────────┘

💡 经验法则：
  系统耗时 > 5ms/帧 → 考虑多线程
  系统耗时 < 2ms/帧 → 单线程足够


╔═══════════════════════════════════════════════════════════════╗
║  🎮 游戏类型分析                                               ║
╚═══════════════════════════════════════════════════════════════╝

## ✅ 强烈推荐多线程 ECS

### 1. 大型多人在线游戏 (MMO)
┌────────────────────────────────────────────┐
│ 例子：传奇、魔兽世界类                      │
├────────────────────────────────────────────┤
│ Entities: 10,000+ (玩家+NPC+怪物)          │
│ 系统：                                     │
│  - 物理/移动                               │
│  - AI (大量 NPC)                           │
│  - 战斗计算                                │
│  - 技能系统                                │
│  - 视野裁剪                                │
│                                            │
│ 每帧预算: 16ms                             │
│ 单线程: 无法完成 ❌                        │
│ 多线程: 可行 ✅                            │
└────────────────────────────────────────────┘

### 2. RTS (即时战略)
┌────────────────────────────────────────────┐
│ 例子：星际争霸、帝国时代                    │
├────────────────────────────────────────────┤
│ Entities: 5,000+ (单位+建筑+资源)          │
│ 系统：                                     │
│  - 路径规划 (每单位 A*)                    │
│  - 碰撞避让                                │
│  - AI 决策                                 │
│  - 战斗计算                                │
│  - 视野/迷雾                               │
│                                            │
│ 关键：路径规划非常耗时                     │
│ 多线程收益: 3-4倍 ✅✅                     │
└────────────────────────────────────────────┘

### 3. 大规模模拟游戏
┌────────────────────────────────────────────┐
│ 例子：Cities: Skylines, Rimworld           │
├────────────────────────────────────────────┤
│ Entities: 50,000+ (市民/动物/物品)         │
│ 系统：                                     │
│  - 个体 AI (每个市民独立逻辑)              │
│  - 交通流模拟                              │
│  - 经济计算                                │
│  - 环境模拟                                │
│                                            │
│ 关键：每个 entity 都有复杂逻辑             │
│ 多线程收益: 5-10倍 ✅✅✅                  │
└────────────────────────────────────────────┘

### 4. 弹幕/大量粒子游戏
┌────────────────────────────────────────────┐
│ 例子：东方Project, Vampire Survivors        │
├────────────────────────────────────────────┤
│ Entities: 10,000+ (子弹+粒子+敌人)         │
│ 系统：                                     │
│  - 弹道计算                                │
│  - 碰撞检测 (每帧百万次检测)               │
│  - 粒子更新                                │
│                                            │
│ 关键：海量碰撞检测                         │
│ 多线程收益: 3-4倍 ✅✅                     │
└────────────────────────────────────────────┘


## ⚠️ 可能需要多线程 ECS

### 5. ARPG (动作角色扮演)
┌────────────────────────────────────────────┐
│ 例子：暗黑破坏神、Path of Exile             │
├────────────────────────────────────────────┤
│ Entities: 1,000-5,000                      │
│ 系统：                                     │
│  - 技能效果 (大量粒子)                     │
│  - 碰撞/伤害计算                           │
│  - AI (中等复杂度)                         │
│  - 物品掉落                                │
│                                            │
│ 取决于：战斗激烈程度                       │
│ 单线程: 勉强可行 ⚠️                       │
│ 多线程: 更流畅 ✅                          │
└────────────────────────────────────────────┘

### 6. 塔防游戏
┌────────────────────────────────────────────┐
│ 例子：Kingdom Rush, Bloons TD              │
├────────────────────────────────────────────┤
│ Entities: 500-2,000                        │
│ 系统：                                     │
│  - 路径规划                                │
│  - 攻击判定                                │
│  - 效果计算                                │
│                                            │
│ 取决于：同屏敌人数量                       │
│ 单线程: 通常够用 ⚠️                       │
│ 多线程: 后期关卡有帮助 ✅                  │
└────────────────────────────────────────────┘


## ❌ 不推荐多线程 ECS

### 7. 平台跳跃游戏
┌────────────────────────────────────────────┐
│ 例子：Super Mario, Celeste                 │
├────────────────────────────────────────────┤
│ Entities: 50-200                           │
│ 系统：简单物理+碰撞                         │
│                                            │
│ 单线程性能: 0.5ms                          │
│ 多线程开销 > 收益 ❌                        │
└────────────────────────────────────────────┘

### 8. 回合制游戏
┌────────────────────────────────────────────┐
│ 例子：XCOM, Civilization                   │
├────────────────────────────────────────────┤
│ Entities: 100-500                          │
│ 特点：不需要每帧更新                        │
│                                            │
│ 回合制 = 不在乎单帧性能                    │
│ 多线程无意义 ❌                             │
└────────────────────────────────────────────┘

### 9. 小型独立游戏
┌────────────────────────────────────────────┐
│ 例子：Stardew Valley, Undertale            │
├────────────────────────────────────────────┤
│ Entities: < 500                            │
│ 系统：简单                                 │
│                                            │
│ 单线程完全够用 ❌                          │
│ 复杂度不值得 ❌                             │
└────────────────────────────────────────────┘

### 10. 卡牌/棋牌游戏
┌────────────────────────────────────────────┐
│ 例子：Hearthstone, Slay the Spire          │
├────────────────────────────────────────────┤
│ Entities: < 100                            │
│ 特点：UI驱动，逻辑简单                      │
│                                            │
│ 完全不需要 ❌                               │
└────────────────────────────────────────────┘


╔═══════════════════════════════════════════════════════════════╗
║  🎯 决策树                                                     ║
╚═══════════════════════════════════════════════════════════════╝

开始
  │
  ├─ Entity 数量 < 1000？
  │   └─ YES → ❌ 单线程足够
  │   └─ NO  → 继续
  │
  ├─ 系统计算密集（物理/AI/路径规划）？
  │   └─ NO  → ❌ 单线程足够
  │   └─ YES → 继续
  │
  ├─ 可以有效分区（空间/实体类型）？
  │   └─ NO  → ⚠️ 多线程效果有限
  │   └─ YES → 继续
  │
  ├─ 开发团队有多线程经验？
  │   └─ NO  → ⚠️ 考虑学习成本
  │   └─ YES → 继续
  │
  └─ 单线程性能瓶颈 > 10ms/帧？
      └─ NO  → ❌ 暂不需要
      └─ YES → ✅ 推荐多线程 ECS


╔═══════════════════════════════════════════════════════════════╗
║  💡 实际建议                                                   ║
╚═══════════════════════════════════════════════════════════════╝

## 渐进式采用策略

阶段 1: 单线程 ECS
  - 先用单线程实现完整功能
  - 性能测试，找出瓶颈
  - 确认是否真的需要多线程

阶段 2: 混合模式
  - 只把最耗时的系统多线程化
  - 例如：物理系统用 Worker，其他单线程
  - 收益明显，复杂度可控

阶段 3: 完全多线程 ECS
  - 所有系统并行化
  - 适用于确定需要的大型项目


## 替代方案

在决定多线程 ECS 之前，考虑：

1️⃣ 算法优化
   - 空间分区（四叉树/八叉树）
   - 更好的碰撞算法
   - LOD（远处简化计算）
   - 通常能提升 10-100 倍

2️⃣ 数据优化
   - SoA 布局
   - 缓存友好的内存访问
   - 预计算/查表
   - 通常能提升 2-5 倍

3️⃣ 部分多线程
   - 只把耗时操作放 Worker
   - 例如：路径规划异步计算
   - 简单得多


╔═══════════════════════════════════════════════════════════════╗
║  📈 性能数据参考 (实测)                                        ║
╚═══════════════════════════════════════════════════════════════╝

游戏类型         Entities  单线程   多线程(4核)  收益
─────────────────────────────────────────────────────────
弹幕游戏         10,000    25ms     8ms          3.1x ✅
RTS              5,000     30ms     10ms         3.0x ✅
MMO (视野内)      2,000     15ms     6ms          2.5x ✅
ARPG             1,500     8ms      5ms          1.6x ⚠️
平台跳跃         200       0.5ms    1.2ms        0.4x ❌
塔防             800       3ms      3.5ms        0.8x ❌


╔═══════════════════════════════════════════════════════════════╗
║  ✅ 最终建议                                                   ║
╚═══════════════════════════════════════════════════════════════╝

你的游戏适合多线程 ECS 吗？

测试方法：
1. 先实现单线程版本
2. 在目标设备上测试性能
3. 如果帧时间 > 16ms (60 FPS) 且主要耗时在 ECS 系统
   → 考虑多线程

具体标准：
✅ Entity > 2000 + 复杂系统
✅ 单线程瓶颈 > 10ms/帧
✅ 系统可独立并行
✅ 团队有多线程经验

❌ Entity < 1000
❌ 系统简单 (移动+渲染)
❌ 首个项目/原型
❌ 团队无多线程经验

记住：过早优化是万恶之源！
先做出来，再优化性能 🎯

